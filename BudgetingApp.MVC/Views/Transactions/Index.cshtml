@using BudgetingApp.BLL.DTOs
@using BudgetingApp.MVC.Controllers
@using Newtonsoft.Json
@model IEnumerable<BudgetingApp.BLL.DTOs.TransactionDTO>

@{
	ViewData["Title"] = "Index";
}

@if (Context.Session.GetString("user") != null)
{
	var userLogin = JsonConvert.DeserializeObject<UserDTO>(Context.Session.GetString("user"));
	var userRole = userLogin.Role;
	@if (userRole != "user" && userRole != "userplus")
	{
		<script>
			window.location.href = '/Home/';
		</script>
	}
}

<div class="row">
	<div class="d-sm-flex align-items-center justify-content-between mb-4">
		<h1 class="mt-4 mb-4"></h1>
	</div>
	<div class="col-lg-12">
		<!-- Basic Card Example -->
		<div class="card shadow mb-4">
			<div class="card-header py-3">
				<h6 class="m-0 font-weight-bold text-primary">List User With Role Page</h6>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col">
						<div class="mb-4">
							<a class="btn btn-primary" asp-action="Create">Create New</a>
						</div>

						@using (Html.BeginForm("Index", "Transactions", FormMethod.Get, new { id = "filter-form" }))
						{
							<div class="form-row align-items-center">
								<div class="col-auto mb-3">
									<label for="monthYear" class="mr-sm-2">Month and Year:</label>
									<input type="month" class="form-control" id="monthYear" name="monthYear" />
								</div>
								<div class="col-auto mb-3">
									<label for="TransactionType" class="mr-sm-2">Transaction Type</label>
									<select id="TransactionType" class="form-control">
										<option value="">All</option>
										<option value="1">Pengeluaran</option>
										<option value="2">Pemasukan</option>
									</select>
								</div>
								<div class="col-auto mb-3">
									<label for="TransactionCategoryID" class="mr-sm-2">Transaction Category</label>
									<select id="TransactionCategoryID" class="form-control">
										<option value="">All</option>
									</select>
								</div>
								@* 								<div class="col-auto mb-3">
							<button type="button" class="btn btn-secondary" id="clearFilter">Clear Filter</button>
							</div> *@
								<div class="col-auto">
									<button type="submit" class="btn btn-primary">Filter</button>
								</div>
							</div>
						}
					</div>
					<div class="col">
						<div class="row">
							<div class="col mb-4">
								<div class="card border-left-primary shadow h-100 py-2">
									<div class="card-body">
										<div class="row no-gutters align-items-center">
											<div class="col mr-2">
												<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
													Total Expense
												</div>
												<div runat="server" class="h5 mb-0 font-weight-bold text-gray-800 mb-3" id="expenseValue">
													@ViewBag.TotalExpense.ToString("C0", new System.Globalization.CultureInfo("id-ID"))
												</div>
											</div>
											<div class="col-auto">
												<i class="fas fa-arrow-up fa-2x text-gray-300"></i>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col mb-4">
								<div class="card border-left-primary shadow h-100 py-2">
									<div class="card-body">
										<div class="row no-gutters align-items-center">
											<div class="col mr-2">
												<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
													Total Income

												</div>
												<div runat="server" class="h5 mb-0 font-weight-bold text-gray-800 mb-3" id="incomeValue">
													@ViewBag.TotalIncome.ToString("C0", new System.Globalization.CultureInfo("id-ID"))
												</div>
											</div>
											<div class="col-auto">
												<i class="fas fa-arrow-down fa-2x text-gray-300"></i>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<table id="transactionTable" class="table table-striped table-bordered" style="width:100%">
					<thead>
						<tr>
							<th>
								@Html.DisplayNameFor(model => model.TransactionCategory.Name)
							</th>
							<th>
								@Html.DisplayNameFor(model => model.TransactionType)
							</th>
							<th>
								@Html.DisplayNameFor(model => model.Amount)
							</th>
							<th>
								@Html.DisplayNameFor(model => model.Date)
							</th>
							<th>
								@Html.DisplayNameFor(model => model.Description)
							</th>

							<th>
								@Html.DisplayNameFor(model => model.WalletName)
							</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model)
						{
							<tr>

								<td>
									@Html.DisplayFor(modelItem => item.TransactionCategory.Name)
								</td>
								<td>
									@{
										string transactionTypeText = item.TransactionCategory.TransactionTypeID == 1 ? "Pengeluaran" : "Pemasukan";
									}
									@transactionTypeText
								</td>
								<td>
									@Html.Raw(Helper.FormatToIDR(item.Amount))
								</td>
								<td>
									@Html.Raw(Helper.FormatDate(item.Date))
								</td>
								<td>
									@Html.DisplayFor(modelItem => item.Description)
								</td>

								<td>
									@Html.DisplayFor(modelItem => item.WalletName)
								</td>
								<td>
									@Html.ActionLink("Edit", "Edit", new { id = item.TransactionID }, new { @class = "btn btn-sm btn-primary" })
									@Html.ActionLink("Delete", "Delete", new { id = item.TransactionID }, new { @class = "btn btn-sm btn-danger delete-btn" })


									@* <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
								<div class="modal-dialog" role="document">
								<div class="modal-content">
								<div class="modal-header">
								<h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
								</button>
								</div>
								<div class="modal-body">
								Are you sure you want to delete this item?
								</div>
								<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
								<a asp-action="Delete" asp-route-id="@item.TransactionID"deleteLink" class="btn btn-danger">Delete</a>
								</div>
								</div>
								</div>
								</div> *@
								</td>
							</tr>
						}
					</tbody>
				</table>

			</div>
		</div>
	</div>
</div>





@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}

	<script>
		$(document).ready(function () {
			// $('.delete-btn').click(function (e) {
			// 	e.preventDefault();
			// 	var deleteUrl = $(this).attr('href'); // URL for delete link

			// 	// Set href attribute for deleteLink
			// 	$('#deleteLink').attr('href', deleteUrl);

			// 	// Show modal
			// 	$('#confirmDeleteModal').modal('show');
			// });

		});
	</script>

	<script>
		$(document).ready(function () {
			$('#transactionTable').DataTable({
				"order": [[3, "desc"]] // Urutkan berdasarkan kolom ke-3 (indeks dimulai dari 0), yang merupakan kolom Date, secara descending
			});
		});
	</script>


	<script src="~/startbootstrap/vendor/datatables/jquery.dataTables.min.js"></script>
	<script src="~/startbootstrap/vendor/datatables/dataTables.bootstrap4.min.js"></script>


	<script>
		$(document).ready(function () {
			// Sembunyikan opsi TransactionCategoryID awalnya
			$('#TransactionCategoryID').hide();

			// Ketika nilai TransactionTypeID berubah
			$('#TransactionType').change(function () {
				var selectedType = $(this).val();
				var url = '@Url.Action("GetCategoryByType", "Transactions")'; // Ubah sesuai dengan URL yang sesuai

				// Mengambil data kategori berdasarkan tipe transaksi
				$.getJSON(url, { transactionTypeId: selectedType }, function (data) {
					var items = '<option value="">Pilih Kategori</option>'; // Tambahkan opsi default
					$.each(data, function (i, category) {
						items += "<option value='" + category.value + "'>" + category.text + "</option>";
					});

					// Perbarui opsi TransactionCategoryID
					$('#TransactionCategoryID').html(items).show();
				});
			}).trigger('change'); // Memanggil event change saat halaman dimuat untuk menampilkan dropdown category pertama kali
		});
	</script>

	<script>
		$(document).ready(function () {
			// Ketika form filter disubmit
			$('#filter-form').submit(function (event) {
				// Mencegah form dari pengiriman langsung
				event.preventDefault();

				// Mengambil nilai bulan dan tahun dari input monthYear
				var monthYearValue = $('#monthYear').val();

				// Memisahkan nilai bulan dan tahun
				var year = monthYearValue.split('-')[0];
				var month = monthYearValue.split('-')[1];

				// Mengambil nilai transaction type dari dropdown
				var transactionType = $('#TransactionType').val();

				// Mengambil nilai transaction category dari dropdown
				var transactionCategoryID = $('#TransactionCategoryID').val();

				// Mengirimkan nilai tahun, bulan, transaction type, dan transaction category ke action Index pada controller
				window.location.href = '@Url.Action("Index", "Transactions")?year=' + year + '&month=' + month + '&transactionTypeID=' + transactionType + '&transactionCategoryID=' + transactionCategoryID;
			});
		});
	</script>

	<script>
		$(document).ready(function () {
			// Set nilai default untuk input bulan dan tahun
			var currentDate = new Date();
			var currentMonth = currentDate.getMonth() + 1; // Penambahan 1 karena bulan dimulai dari 0
			var currentYear = currentDate.getFullYear();
			var monthYearValue = currentYear + '-' + (currentMonth < 10 ? '0' : '') + currentMonth; // Format nilai monthYear seperti 'YYYY-MM'

			$('#monthYear').val(monthYearValue);

			// Tombol Clear Filter
			$('#clearFilter').click(function () {
				$('#monthYear').val(''); // Menghapus nilai dari input bulan dan tahun
				$('#TransactionType').val(''); // Menghapus nilai dari dropdown transaction type
				$('#TransactionCategoryID').val(''); // Menghapus nilai dari dropdown transaction category
				$('#filter-form').submit(); // Mengirim form untuk melakukan filtering ulang
			});
		});
	</script>
}
