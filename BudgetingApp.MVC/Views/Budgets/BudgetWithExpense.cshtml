@using BudgetingApp.BLL.DTOs
@using Newtonsoft.Json
@{
	ViewData["Title"] = "BudgetWithExpense";
}

@if (Context.Session.GetString("user") != null)
{
    var userLogin = JsonConvert.DeserializeObject<UserDTO>(Context.Session.GetString("user"));
    var userRole = userLogin.Role;
    @if (userRole != "userplus")
    {
        <script>
            window.location.href = '/Home/';
        </script>
    }
}

<div class="row">
	<div class="d-sm-flex align-items-center justify-content-between mb-4">
		<h1 class="mt-4 mb-4"></h1>
	</div>
	<div class="col-lg-12">
		<!-- Basic Card Example -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Budget with Expense</h6>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <a class="btn btn-primary" asp-action="Create">Create New Budget</a>
                </div>
                <div class="row">
                    @foreach (var budget in ViewBag.Budgets)
                    {
                        <div class="col-xl-4 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100">
                                <div class="card-body">
                                    <div class="text-primary text-uppercase mb-2">
                                        <span>@budget.TransactionCategoryName</span>
                                        <span class="float-right">@string.Format("{0:MMMM yyyy}", budget.MonthDate)</span>
                                    </div>
                                    <hr />
                                    <div class="mb-3">
                                        <div class="text-gray-800">
                                            <span>Budget:</span>
                                            <span>@budget.Amount.ToString("C0", new System.Globalization.CultureInfo("id-ID"))</span>
                                        </div>
                                        <div class="text-gray-800">
                                            <span>Expense:</span>
                                            <span>@(((decimal)(ViewBag.ExpensesByCategory[budget.TransactionCategoryID] ?? 0)).ToString("C0", new System.Globalization.CultureInfo("id-ID")))</span>
                                        </div>
                                        <div class="text-primary">
                                            <span>Remaining:</span>
                                            <span>@budget.RemainingAmount.ToString("C0", new System.Globalization.CultureInfo("id-ID"))</span>
                                        </div>
                                    </div>
                                    @if (budget.Amount > 0)
                                    {
                                        var progressPercentage = Math.Min(((decimal)(ViewBag.ExpensesByCategory[budget.TransactionCategoryID] ?? 0) / budget.Amount) * 100, 100);
                                        <div class="progress mb-3">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: @progressPercentage%" aria-valuenow="@progressPercentage" aria-valuemin="0" aria-valuemax="100">
                                                @progressPercentage.ToString("0.0")%
                                            </div>
                                        </div>
                                    }
                                    <div class="text-center">
                                        @Html.ActionLink("Edit", "Edit", new { id = budget.BudgetID }, new { @class = "btn btn-primary btn-sm" }) |
                                        @Html.ActionLink("Delete", "Delete", new { id = budget.BudgetID }, new { @class = "btn btn-danger btn-sm" })
                                    </div>

                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

	</div>
</div>
